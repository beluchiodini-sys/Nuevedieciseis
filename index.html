<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>NUEVEDIECISEIS ‚Ä¢ Gesti√≥n de Equipos</title>
  <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f6f8; }
    h2 { display: flex; justify-content: space-between; }
    table { border-collapse: collapse; width: 100%; background: white; box-shadow: 0 0 5px #ccc; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: center; }
    input, select, textarea { width: 90%; padding: 6px; margin-top: 4px; }
    canvas { margin-top: 5px; }
    button { padding: 6px 12px; margin: 5px; cursor: pointer; }
    .carpeta { margin-top: 20px; padding: 15px; background: #eef; border-radius: 8px; }
    .cronometro { font-weight: bold; color: #007700; font-size: 1.1em; }
    .resaltar-rojo { background-color: #ffcccc !important; }
    .resaltar-verde { background-color: #ccffcc !important; }
    .resaltar-amarillo { background-color: #ffffcc !important; }
  </style>
</head>
<body>

<h2>NUEVEDIECISEIS <span id="reloj">‚è±Ô∏è</span></h2>

<table id="tabla">
  <tr>
    <th>Equipo</th><th>Interno</th><th>Modelo</th><th>N¬∞ Base</th>
    <th>Horas Base</th><th>Horas Actuales</th><th>Servicio</th><th>QR</th><th>Acci√≥n</th>
  </tr>
</table>
<button onclick="agregarFila()">Agregar fila</button>
<div id="carpetas"></div>

<script>
const carpetas = {};

setInterval(() => {
  document.getElementById("reloj").textContent = "‚è± " + new Date().toLocaleTimeString();
}, 1000);

function agregarFila() {
  const fila = document.createElement("tr");
  const campos = ['equipo','interno','modelo','nroBase','horasBase','horasActuales'];
  campos.forEach(campo => {
    const td = document.createElement("td");
    const input = document.createElement("input");
    input.type = campo.includes('Horas') ? "number" : "text";
    if (campo === 'horasBase') {
      input.addEventListener("input", () => verificarColor(input));
    }
    td.appendChild(input);
    fila.appendChild(td);
  });

  const servicioTd = document.createElement("td");
  const select = document.createElement("select");
  ['Motor','Transmisi√≥n','Hidr√°ulico','Otro'].forEach(tipo => {
    const opt = document.createElement("option");
    opt.text = tipo;
    select.add(opt);
  });
  servicioTd.appendChild(select);
  fila.appendChild(servicioTd);

  const qrTd = document.createElement("td");
  const canvas = document.createElement("canvas");
  canvas.width = 80;
  canvas.height = 80;
  qrTd.appendChild(canvas);
  fila.appendChild(qrTd);

  const btnTd = document.createElement("td");
  const btn = document.createElement("button");
  btn.textContent = "Crear carpeta";
  btn.onclick = () => crearCarpeta(fila, canvas);
  btnTd.appendChild(btn);
  fila.appendChild(btnTd);

  document.getElementById("tabla").appendChild(fila);
}

function verificarColor(input) {
  const val = parseInt(input.value);
  const celda = input.parentElement;
  celda.className = "";
  const fila = celda.parentElement;
  const selectServicio = fila.querySelector("select");
  const idServicio = selectServicio.value;
  const hora = new Date().toLocaleTimeString();

  if (!isNaN(val)) {
    if (val >= 200 && val <= 250) {
      celda.classList.add("resaltar-rojo");
      selectServicio.value = "Motor";
      registrarCambioAutom√°tico(fila, `Estado ROJO: Motor`, hora);
    }
    else if (val >= 950 && val <= 1000) {
      celda.classList.add("resaltar-verde");
      selectServicio.value = "Transmisi√≥n";
      registrarCambioAutom√°tico(fila, `Estado VERDE: Transmisi√≥n`, hora);
    }
    else if (val >= 1950 && val <= 2000) {
      celda.classList.add("resaltar-amarillo");
      selectServicio.value = "Hidr√°ulico";
      registrarCambioAutom√°tico(fila, `Estado AMARILLO: Hidr√°ulico`, hora);
    }
  }
}

function registrarCambioAutom√°tico(fila, texto, hora) {
  const btn = fila.querySelector("button");
  if (!btn || !btn.onclick) return;
  const id = btn.onclick.toString().match(/crearCarpeta\(.*?,.*?\);.*?carpetas

\['(.+?)'\]

/)?.[1];
  const manual = btn.getAttribute("data-id");
  const idExtra = manual || Object.keys(carpetas).slice(-1)[0];
  if (carpetas[idExtra]) {
    const log = `üìå ${hora} ‚Äî ${texto}`;
    carpetas[idExtra].acciones.push(log);
    localStorage.setItem(idExtra, JSON.stringify(carpetas[idExtra]));
    actualizarHistorial(idExtra);
  }
}

function crearCarpeta(fila, canvas) {
  const inputs = fila.querySelectorAll("input");
  const select = fila.querySelector("select");
  const valores = [...inputs].map(i => i.value.trim());
  const tipoServicio = select.value;
  const id = `carpeta_${valores[3]}_${Date.now()}`;
  const creado = Date.now();

  carpetas[id] = {
    equipo: valores[0],
    interno: valores[1],
    modelo: valores[2],
    base: valores[3],
    horasBase: valores[4],
    servicio: tipoServicio,
    creado,
    acciones: []
  };

  localStorage.setItem(id, JSON.stringify(carpetas[id]));
  const url = location.href + `#${encodeURIComponent(id)}`;
  new QRious({ element: canvas, value: url, size: 80 });
  mostrarCarpeta(id);
}

function mostrarCarpeta(id) {
  const datos = carpetas[id];
  const div = document.createElement("div");
  div.className = "carpeta";
  div.innerHTML = `
    <h3>üìÅ Carpeta: ${id}</h3>
    <p><strong>Equipo:</strong> ${datos.equipo}</p>
    <p><strong>Interno:</strong> ${datos.interno}</p>
    <p><strong>Modelo:</strong> ${datos.modelo}</p>
    <p><strong>N¬∞ Base:</strong> ${datos.base}</p>
    <p><strong>Horas Base:</strong> ${datos.horasBase}</p>
    <p><strong>Servicio:</strong> ${datos.servicio}</p>
    <p><strong>Horas Actuales:</strong> <span id="cron_${id}" class="cronometro">00:00:00</span></p>
    <textarea id="txt_${id}" placeholder="Escribir acci√≥n..."></textarea>
    <button onclick="guardarAccion('${id}')">üíæ Guardar acci√≥n</button>
    <button onclick="descargarDocumento('${id}')">üì• Descargar documento</button>
    <ul id="hist_${id}"></ul>
  `;
  document.getElementById("carpetas").appendChild(div);
  iniciarCronometro(id, datos.creado);
  actualizarHistorial(id);
}

function iniciarCronometro(id, inicio) {
  setInterval(() => {
    const delta = Math.floor((Date.now() - inicio)/1000);
    const hh = String(Math.floor(delta/3600)).padStart(2,'0');
    const mm = String(Math.floor((delta%
