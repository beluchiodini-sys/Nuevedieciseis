<!DOCTYPE html>
<html lang="es">
  </style>
</head>
<body>
  <h2>NUEVEDIECISEIS <span id="reloj">â±</span></h2>
  <table id="tabla">
    <tr>
      <th>Equipo</th><th>Interno</th><th>Modelo</th><th>NÂ° Base</th><th>Horas Base</th><th>Horas Actuales</th><th>Servicio</th><th>QR</th><th>AcciÃ³n</th>
    </tr>
  </table>
  <button onclick="agregarFila()">Agregar fila</button>
  <datalist id="listaBases"></datalist>
  <div id="carpetas"></div>

   

  <<script type="module">
import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs";

fetch("https://beluchiodini-sys.github.io/Nuevedieciseis/planillatecnica.xlsx")
  .then((res) => res.arrayBuffer())
  .then((ab) => {
    const wb = XLSX.read(ab);
    const hoja = wb.Sheets[wb.SheetNames[0]];
    const datos = XLSX.utils.sheet_to_json(hoja, { header: 1 });

    // Buscamos la columna con el nombre exacto
    const indice = datos[0].indexOf("N. DE SERIE:");

    if (indice === -1) {
      alert("âŒ No se encontrÃ³ la columna 'N. DE SERIE:'");
      return;
    }
 const carpetas = {};
    const cronometrosActivos = {};
    let basesDesdeExcel = [];

    setInterval(() => {
      document.getElementById("reloj").textContent = "â± " + new Date().toLocaleTimeString();
    }, 1000);
    const bases = datos.slice(1).map(fila => fila[indice]).filter(x => !!x);

    console.log(`âœ… Bases cargadas desde Excel: ${bases.length}`);

    const datalist = document.getElementById("datalistOptions");
    if (!datalist) {
      console.warn("âš ï¸ No se encontrÃ³ el datalist con id 'datalistOptions'");
      return;
    }

    bases.forEach(valor => {
      const option = document.createElement("option");
      option.value = valor;
      datalist.appendChild(option);
    });
  })
  .catch(err => {
    console.error("âŒ Error al cargar el Excel:", err);
  });
        basesDesdeExcel = datos.slice(1).map(f => f[indice]).filter(Boolean);

        const datalist = document.getElementById("listaBases");
        basesDesdeExcel.forEach(base => {
          const opt = document.createElement("option");
          opt.value = base;
          datalist.appendChild(opt);
        });

        console.log("âœ… Bases cargadas desde Excel:", basesDesdeExcel.length);
      });

    function agregarFila() {
      const fila = document.createElement("tr");
      const campos = ['equipo','interno','modelo','nroBase','horasBase','horasActuales'];
      campos.forEach(campo => {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = campo.includes('Horas') ? "number" : "text";
        if (campo === 'nroBase' && basesDesdeExcel.length > 0) {
          input.setAttribute("list", "listaBases");
        }
        if (campo === 'horasBase') {
          input.addEventListener("input", () => verificarColor(input));
        }
        td.appendChild(input);
        fila.appendChild(td);
      });

      const servicioTd = document.createElement("td");
      const select = document.createElement("select");
      ['Motor','TransmisiÃ³n','HidrÃ¡ulico','Otro'].forEach(tipo => {
        const opt = document.createElement("option");
        opt.text = tipo;
        select.add(opt);
      });
      servicioTd.appendChild(select);
      fila.appendChild(servicioTd);

      const qrTd = document.createElement("td");
      const canvas = document.createElement("canvas");
      canvas.width = 80;
      canvas.height = 80;
      qrTd.appendChild(canvas);
      fila.appendChild(qrTd);

      const btnTd = document.createElement("td");
      const btn = document.createElement("button");
      btn.textContent = "Crear carpeta";
      btn.onclick = () => crearCarpeta(fila, canvas);
      btnTd.appendChild(btn);
      fila.appendChild(btnTd);

      document.getElementById("tabla").appendChild(fila);
    }

    function verificarColor(input) {
      const val = parseInt(input.value);
      const td = input.parentElement;
      const fila = td.parentElement;
      const select = fila.querySelector("select");
      td.className = "";
      let mensaje = "";
      const hora = new Date().toLocaleTimeString();

      if (!isNaN(val)) {
        if (val >= 200 && val <= 250) {
          td.classList.add("resaltar-rojo");
          select.value = "Motor";
          mensaje = `Estado ROJO: Motor`;
        } else if (val >= 950 && val <= 1000) {
          td.classList.add("resaltar-verde");
          select.value = "TransmisiÃ³n";
          mensaje = `Estado VERDE: TransmisiÃ³n`;
        } else if (val >= 1950 && val <= 2000) {
          td.classList.add("resaltar-amarillo");
          select.value = "HidrÃ¡ulico";
          mensaje = `Estado AMARILLO: HidrÃ¡ulico`;
        }

        const id = Object.keys(carpetas).slice(-1)[0];
        if (id && carpetas[id]) {
          carpetas[id].acciones.push(`ğŸ“Œ ${hora} â€” ${mensaje}`);
          localStorage.setItem(id, JSON.stringify(carpetas[id]));
          actualizarHistorial(id);
        }
      }
    }

    function crearCarpeta(fila, canvas) {
      const inputs = fila.querySelectorAll("input");
      const select = fila.querySelector("select");
      const valores = [...inputs].map(i => i.value.trim());
      const tipoServicio = select.value;
      const id = `carpeta_${valores[3]}_${Date.now()}`;
      const creado = Date.now();

      carpetas[id] = {
        equipo: valores[0],
        interno: valores[1],
        modelo: valores[2],
        base: valores[3],
        horasBase: valores[4],
        servicio: tipoServicio,
        creado,
        acciones: []
      };

      localStorage.setItem(id, JSON.stringify(carpetas[id]));
      const url = location.href.split("#")[0] + `#${encodeURIComponent(id)}`;
      new QRious({ element: canvas, value: url, size: 80 });
      mostrarCarpeta(id);
    }

    function mostrarCarpeta(id) {
      const datos = carpetas[id];
      const div = document.createElement("div");
      div.className = "carpeta";
      div.innerHTML = `
        <h3>ğŸ“ Carpeta: ${id}</h3>
        <p><strong>Equipo:</strong> ${datos.equipo}</p>
        <p><strong>Interno:</strong> ${datos.interno}</p>
        <p><strong>Modelo:</strong> ${datos.modelo}</p>
        <p><strong>NÂ° Base:</strong> ${datos.base}</p>
        <p><strong>Horas Base:</strong> ${datos.horasBase}</p>
        <p><strong>Servicio:</strong> ${datos.servicio}</p>
        <p><strong>Horas Actuales:</strong> <span id="cron_${id}" class="cronometro">00:00:00</span></p>
        <textarea id="txt_${id}" placeholder="Escribir acciÃ³n..."></textarea>
        <button onclick="guardarAccion('${id}')">ğŸ’¾ Guardar acciÃ³n</button>
        <button onclick="descargarDocumento('${id}')">ğŸ“¥ Descargar documento</button>
        <button onclick="eliminarCarpeta('${id}')">ğŸ—‘ï¸ Eliminar carpeta</button>
        <ul id="hist_${id}"></ul>
      `;
      document.getElementById("carpetas").appendChild(div);
      iniciarCronometro(id, datos.creado);
      actualizarHistorial(id);
    }

    function iniciarCronometro(id, inicio) {
      if (cronometrosActivos[id]) clearInterval(cronometrosActivos[id]);
      const cronEl = document.getElementById(`cron_${id}`);
      if (!cronEl) return;
      cronometrosActivos[id] = setInterval(() => {
        const delta = Math.floor((Date.now() - inicio) / 1000);
        const hh = String(Math.floor(delta / 3600)).padStart(2, '0');
        const mm = String(Math.floor((delta % 3600) / 60)).padStart(2, '0');
        const ss = String(delta % 60).padStart(2, '0');
        cronEl.textContent = `${hh}:${mm}:${ss}`;
      }, 1000);
    }

    function guardarAccion(id) {
      const txt = document.getElementById(`txt_${id}`).value.trim();
      if (!txt) return;
      const fecha = new Date().toLocaleString();
      carpetas[id].acciones.push(`${fecha}: ${txt}`);
      localStorage.setItem(id, JSON.stringify(carpetas[id]));
      document.getElementById(`txt_${id}`).value = "";
      actualizarHistorial(id);
    }

    function actualizarHistorial(id) {
      const ul = document.getElementById(`hist_${id}`);
      ul.innerHTML = "";
      carpetas[id].acciones.forEach((accion, i) => {
        const li = document.createElement("li");
        li.textContent = accion;
        const btnBorrar = document.createElement("button");
        btnBorrar.textContent = "ğŸ—‘ï¸";
        btnBorrar.onclick = () => {
          carpetas[id].acciones.splice(i, 1);
          localStorage.setItem(id, JSON.stringify(carpetas[id]));
          actualizarHistorial(id);
        };
        li.appendChild(btnBorrar);
        ul.appendChild(li);
      });
    }

    function descargarDocumento(id) {
      const datos = carpetas[id];
      let contenido = `Carpeta: ${id}\n`;
      contenido += `Equipo: ${datos.equipo}\nInterno: ${datos.interno}\nModelo: ${datos.modelo}\n`;
      contenido += `NÂ° Base: ${datos.base}\nHoras Base: ${datos.horasBase}\nServicio: ${datos.servicio}\n\nAcciones:\n`;
      datos.acciones.forEach(accion => contenido += `- ${accion}\n`);
      const blob = new Blob([contenido], { type: 'text/plain' });
      const enlace = document.createElement("a");
      enlace.href = URL.createObjectURL(blob);
      enlace.download = `${id}.txt`;
      enlace.click();
    }

    function eliminarCarpeta(id) {
      localStorage.removeItem(id);
      delete carpetas[id];
      const divs = document.querySelectorAll(".carpeta");
      divs.forEach(div => {
        if (div.innerHTML.includes(id)) div.remove();
      });
    }

    window.addEventListener("load", () => {
      const hash = location.hash.replace("#", "");
      if (hash && localStorage.getItem(hash)) {
        const datos = JSON.parse(localStorage.getItem(hash));
        carpetas[hash] = datos;
        mostrarCarpeta(hash);
      } else {
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith("carpeta_")) {
            const datos = JSON.parse(localStorage.getItem(key));
            carpetas[key] = datos;
            mostrarCarpeta(key);
          }
        });
      }
    });
  </script>
</body>
</html>
