<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NUEVEDIECISEIS</title>
  <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f6f8; }
    h2 { display: flex; justify-content: space-between; align-items: center; }
    table, th, td { border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: center; }
    input, select, textarea { width: 100%; padding: 6px; margin-top: 4px; }
    button { padding: 6px 12px; margin: 5px 0; cursor: pointer; width: 100%; }
    canvas { margin-top: 10px; }
    .carpeta { margin-top: 20px; padding: 15px; background: #eef; border-radius: 8px; }
    .cronometro { font-weight: bold; color: #007700; font-size: 1.1em; }
    .editable-area { width: 100%; height: 300px; background: #fff; border: 1px solid #ccc; padding: 10px; font-family: monospace; margin-top: 10px; white-space: pre-wrap; }
    .formulario-inicial { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px; }
    .formulario-inicial label { font-weight: bold; }
  </style>
</head>
<body>
  <h2>NUEVEDIECISEIS <span id="reloj">‚è±</span></h2>
  
  <div class="formulario-inicial">
    <label>EMPRESA: <input id="empresa" type="text" /></label>
    <label>EQUIPO: <input id="equipo" type="text" /></label>
    <label>INTERNO: <input id="interno" type="text" /></label>
    <label>MARCA MODELO: <input id="modelo" type="text" /></label>
    <label>PATENTE: <input id="patente" type="text" /></label>
    <label>HORAS/KM: <input id="horas" type="text" /></label>
    <label>N. DE SERIE: <input id="serie" type="text" /></label>
    <label>SERVICIO:
      <select id="servicio">
        <option>Motor</option>
        <option>Transmisi√≥n</option>
        <option>Hidr√°ulico</option>
        <option>Otro</option>
      </select>
    </label>
    <button onclick="crearCarpetaDesdeFormulario()">Crear Carpeta</button>
  </div>

  <div id="carpetas"></div>

  <script>
    const carpetas = {};
    const cronometrosActivos = {};

    const fichaOriginal = `PLANILLA T√âCNICA\n\nEMPRESA:\nEQUIPO:\t\tINTERNO:\nMARCA MODELO:\t\tPATENTE:\nHORAS/KM:\nN. DE SERIE:\n\nMOTOR\nITEM\tDESCRIPCI√ìN\tMARCA/MODELO\tCANTIDAD\n1\tACEITE\n2\tFILTRO ACEITE\n...`;

    function crearCarpetaDesdeFormulario() {
      const id = `carpeta_${Date.now()}`;
      const carpeta = {
        empresa: getValue("empresa"),
        equipo: getValue("equipo"),
        interno: getValue("interno"),
        modelo: getValue("modelo"),
        base: getValue("patente"),
        horasBase: getValue("horas"),
        serie: getValue("serie"),
        servicio: getValue("servicio"),
        creado: Date.now(),
        acciones: [],
        fichaEditable: fichaOriginal
      };
      localStorage.setItem(id, JSON.stringify(carpeta));
      mostrarCarpeta(id, carpeta);
      location.hash = id; // Actualiza la URL
    }

    function getValue(id) {
      return document.getElementById(id).value.trim();
    }

    function mostrarCarpeta(id, datos) {
      if (!datos) {
        try {
          datos = JSON.parse(localStorage.getItem(id));
          if (!datos) return;
        } catch (e) { return; }
      }

      const div = document.createElement("div");
      div.className = "carpeta";
      div.id = `div_${id}`;
      const url = `${location.origin}${location.pathname}#${id}`;

      div.innerHTML = `
        <h3>üìÅ Carpeta: ${datos.equipo}</h3>
        <canvas id="qr_${id}" width="100" height="100"></canvas>
        <p><strong>EMPRESA:</strong> ${datos.empresa}</p>
        <p><strong>INTERNO:</strong> ${datos.interno}</p>
        <p><strong>MODELO:</strong> ${datos.modelo}</p>
        <p><strong>PATENTE:</strong> ${datos.base}</p>
        <p><strong>HORAS:</strong> ${datos.horasBase}</p>
        <p><strong>SERVICIO:</strong> ${datos.servicio}</p>
        <p><strong>TIEMPO ACTUAL:</strong> <span id="cron_${id}" class="cronometro">00:00:00</span></p>
        <textarea id="txt_${id}" placeholder="Escribir acci√≥n..."></textarea>
        <button onclick="guardarAccion('${id}')">üíæ Guardar acci√≥n</button>
        <button onclick="descargarDocumento('${id}')">üì• Descargar documento</button>
        <button onclick="descargarQR('${id}')">üì∑ Descargar QR</button>
        <button onclick="eliminarCarpeta('${id}')">üóëÔ∏è Eliminar carpeta</button>
        <ul id="hist_${id}"></ul>
        <textarea id="ficha_${id}" class="editable-area" onchange="guardarFicha('${id}')">${datos.fichaEditable}</textarea>
      `;
      document.getElementById("carpetas").appendChild(div);
      new QRious({ element: document.getElementById(`qr_${id}`), value: url, size: 100 });
      iniciarCronometro(id, datos.creado);
      actualizarHistorial(id);
      setTimeout(() => div.scrollIntoView({ behavior: "smooth" }), 300);
    }

    function guardarAccion(id) {
      const txt = document.getElementById(`txt_${id}`).value.trim();
      if (!txt) return;
      const datos = JSON.parse(localStorage.getItem(id));
      datos.acciones.push(`${new Date().toLocaleString()}: ${txt}`);
      localStorage.setItem(id, JSON.stringify(datos));
      document.getElementById(`txt_${id}`).value = "";
      actualizarHistorial(id);
    }

    function actualizarHistorial(id) {
      const datos = JSON.parse(localStorage.getItem(id));
      const ul = document.getElementById(`hist_${id}`);
      ul.innerHTML = "";
      datos.acciones.forEach((accion, i) => {
        const li = document.createElement("li");
        li.textContent = accion;
        const btn = document.createElement("button");
        btn.textContent = "üóëÔ∏è";
        btn.onclick = () => {
          datos.acciones.splice(i, 1);
          localStorage.setItem(id, JSON.stringify(datos));
          actualizarHistorial(id);
        };
        li.appendChild(btn);
        ul.appendChild(li);
      });
    }

    function guardarFicha(id) {
      const datos = JSON.parse(localStorage.getItem(id));
      datos.fichaEditable = document.getElementById(`ficha_${id}`).value;
      localStorage.setItem(id, JSON.stringify(datos));
    }

    function descargarQR(id) {
      const canvas = document.getElementById(`qr_${id}`);
      if (!canvas) return;
      const enlace = document.createElement("a");
      enlace.href = canvas.toDataURL("image/png");
      enlace.download = `${id}_QR.png`;
      document.body.appendChild(enlace);
      enlace.click();
      document.body.removeChild(enlace);
    }

    function eliminarCarpeta(id) {
      localStorage.removeItem(id);
      const div = document.getElementById(`div_${id}`);
      if (div) div.remove();
    }

    function iniciarCronometro(id, inicio) {
      if (cronometrosActivos[id]) clearInterval(cronometrosActivos[id]);
      const cronEl = document.getElementById(`cron_${id}`);
      if (!cronEl) return;
      cronometrosActivos[id] = setInterval(() => {
        const delta = Math.floor((Date.now() - inicio) / 1000);
        const hh = String(Math.floor(delta / 3600)).padStart(2, '0');
        const mm = String(Math.floor((delta % 3600) / 60)).padStart(2, '0');
        const ss = String(delta % 60).padStart(2, '0');
        cronEl.textContent = `${hh}:${mm}:${ss}`;
      }, 1000);
    }

    setInterval(() => {
      document.getElementById("reloj").textContent = "‚è± " + new Date().toLocaleTimeString();
    }, 1000);

    // Al cargar la p√°gina, restaurar si hay hash
    window.onload = () => {
      const id = location.hash.slice(1);
      if (id && localStorage.getItem(id)) {
        mostrarCarpeta(id);
      }
    };
  </script>
</body>
</html>

