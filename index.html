<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>NUEVEDIECISEIS - Fichas T√©cnicas</title>
<script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
  window.addEventListener("DOMContentLoaded", () => {
    let carpetaHash = decodeURIComponent(location.hash.slice(1));
    for (let i = 0; i < localStorage.length; i++) {
      const clave = localStorage.key(i);
      if (clave.startsWith("/Nuevedieciseis:carpeta_")) {
        const datos = JSON.parse(localStorage.getItem(clave));
        const cleanKey = clave.replace("/Nuevedieciseis:", "");
        carpetas[cleanKey] = datos;
        mostrarCarpeta(cleanKey);
      }
    }
    if (carpetaHash && carpetas[carpetaHash]) {
      document.getElementById(`qr_${carpetaHash}`)?.scrollIntoView({ behavior: "smooth" });
    }
  });

</script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f6f8; }
    h2 { display: flex; justify-content: space-between; }
    table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 0 5px #ccc; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: center; }
    input, select, textarea { width: 90%; padding: 6px; margin-top: 4px; }
    button { padding: 6px 12px; margin: 5px; cursor: pointer; }
    canvas { margin-top: 5px; }
    .carpeta { margin-top: 20px; padding: 15px; background: #eef; border-radius: 8px; }
    .cronometro { font-weight: bold; color: #007700; font-size: 1.1em; }
    .resaltar-rojo { background-color: #ffcccc !important; }
    .resaltar-verde { background-color: #ccffcc !important; }
    .resaltar-amarillo { background-color: #ffffcc !important; }
    .editable-area { width: 100%; height: 500px; white-space: pre-wrap; background: #fff; border: 1px solid #ccc; padding: 10px; font-family: monospace; margin-top: 10px; }
    .formulario-inicial { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .formulario-inicial label { font-weight: bold; display: block; margin-bottom: 4px; }
    .formulario-inicial input { width: 100%; padding: 6px; }
  </style>
<script>
const carpetas = {};

function mostrarCarpeta(id) {
  const datos = carpetas[id];
  const url = location.href.split("#")[0] + "#" + encodeURIComponent(id);

  const div = document.createElement("div");
  div.className = "carpeta";
  div.innerHTML = `
    <h3>üìÅ Carpeta: ${datos.equipo || "Sin nombre"}</h3>
    <canvas id="qr_${id}" width="200" height="200"></canvas>
    <textarea id="ficha_${id}" class="editable-area">${datos.fichaEditable}</textarea>
  `;

  new QRious({
    element: document.getElementById(`qr_${id}`),
    value: url,
    size: 200
  });

  document.getElementById("carpetas").appendChild(div);
}

window.addEventListener("DOMContentLoaded", () => {
  // ‚è± Cron√≥metro
  setInterval(() => {
    const reloj = document.getElementById("reloj");
    if (reloj) reloj.textContent = "‚è± " + new Date().toLocaleTimeString();
  }, 1000);

  // üìÇ Cargar carpetas desde localStorage
  Object.keys(localStorage).forEach(id => {
    if (id.startsWith("carpeta_")) {
      try {
        const datos = JSON.parse(localStorage.getItem(id));
        carpetas[id] = datos;
        mostrarCarpeta(id);
      } catch (e) {
        console.warn("‚ö†Ô∏è Carpeta con error:", id);
      }
    }
  });
});
</script>

</head>
<body>
  <h2>NUEVEDIECISEIS <span id="reloj">‚è±</span></h2>
  <div class="formulario-inicial">
    <div><label>EMPRESA:</label><input id="empresa" type="text" /></div>
    <div></div>
    <div><label>EQUIPO:</label><input id="equipo" type="text" /></div>
    <div><label>INTERNO:</label><input id="interno" type="text" /></div>
    <div><label>MARCA MODELO:</label><input id="modelo" type="text" /></div>
    <div><label>PATENTE:</label><input id="patente" type="text" /></div>
    <div><label>HORAS/KM:</label><input id="horas" type="text" /></div>
    <div><label>N. DE SERIE:</label><input id="serie" type="text" /></div>
    <div><label>SERVICIO:</label>
      <select id="servicio">
        <option>Motor</option>
        <option>Transmisi√≥n</option>
        <option>Hidr√°ulico</option>
        <option>Otro</option>
      </select>
    </div>
    <div><label>&nbsp;</label><button onclick="crearCarpetaDesdeFormulario()">Crear Carpeta</button></div>
  </div>
  <div id="carpetas"></div>
  <script>
    const carpetas = {};
    const cronometrosActivos = {};
    const fichaOriginal = `RIGA 4742 ESTACION FLORES CORDOBA

CP. :5000
TEL. 3517726146
CRISTIAN TABORDA@NUEVEDIECISEIS.COM.AR

PLANILLA T√âCNICA

EMPRESA:
EQUIPO:										INTERNO:
MARCA MODELO:									PATENTE:
HORAS/KM:
N. DE SERIE:

MOTOR
ITEM	DESCRIPCI√ìN	MARCA/MODELO	CANTIDAD
1	ACEITE			
2	FILTRO ACEITE			
3	FILTRO COMBUSTIBLE			
4	FILTRO COMBUSTIBLE			
5	FILTRO DE AIRE			
6	FILTRO DE AIRE			
7	CORREAS			
8	REFRIGERANTE			
9				
10				

TRANSMISI√ìN
1				
2				
3				
4				
5				
6				
7				
8				
9				
10				

HIDR√ÅULICO
1				
2				
3				
4				
5				
6				
7				
8				
9				
10				

NEUM√ÅTICO
1				
2				
3				
4				
5				
6				
7				
8				
9				
10				

EL√âCTRICO
1				
2				
3				
4				
5				
6				
7				
8				
9				
10				

TREN RODANTE
1				
2				
3				
4				
5				
6				
7				
8				
9				
10				

ELEMENTOS DE DESGASTE
1				
2				
3				
4				
5				
6				
7				
8				
9				
10				

CABINA
1				
2				
3				
4				
5				
6				
7				
8				
9				
10				

CHASIS
1				
2				
3				
4				
5				
6				
7				
8				
9				
10				

VARIOS
1				
2				
3				
4				
5				
6				
7				
8				
9				
10				`; 

    function crearCarpetaDesdeFormulario() {
      const equipo = document.getElementById('equipo').value;
      const interno = document.getElementById('interno').value;
      const modelo = document.getElementById('modelo').value;
      const base = document.getElementById('patente').value;
      const horas = document.getElementById('horas').value;
      const serie = document.getElementById('serie').value;
      const empresa = document.getElementById('empresa').value;
      const tipoServicio = document.getElementById('servicio').value;
      const id = `carpeta_${base}_${Date.now()}`;
      const creado = Date.now();

      carpetas[id] = {
        empresa, equipo, interno, modelo, base,
        horasBase: horas, serie, servicio: tipoServicio,
        creado, acciones: [], fichaEditable: fichaOriginal
      };

      localStorage.setItem(id, JSON.stringify(carpetas[id]));
      mostrarCarpeta(id);
    }

    function mostrarCarpeta(id) {
      const url = location.href.split("#")[0] + `#${encodeURIComponent(id)}`;
      const datos = carpetas[id];
      document.title = datos.equipo;
      const div = document.createElement("div");
      div.className = "carpeta";
      div.innerHTML = `
        <h3>üìÅ Carpeta: ${datos.equipo}</h3>
        <canvas id="qr_${id}" width="100" height="100"></canvas>
        <p><strong>EMPRESA:</strong> ${datos.empresa}</p>
        <p><strong>EQUIPO:</strong> ${datos.equipo}</p>
        <p><strong>INTERNO:</strong> ${datos.interno}</p>
        <p><strong>MARCA MODELO:</strong> ${datos.modelo}</p>
        <p><strong>PATENTE (N¬∞ BASE):</strong> ${datos.base}</p>
        <p><strong>HORAS/KM:</strong> ${datos.horasBase}</p>
        <p><strong>N. DE SERIE:</strong> ${datos.serie}</p>
        <p><strong>SERVICIO:</strong> ${datos.servicio}</p>
        <p><strong>TIEMPO ACTUAL:</strong> <span id="cron_${id}" class="cronometro">00:00:00</span></p>
        <textarea id="txt_${id}" placeholder="Escribir acci√≥n..."></textarea>
        <button onclick="guardarAccion('${id}')">üíæ Guardar acci√≥n</button>
        <button onclick="descargarDocumento('${id}')">üì• Descargar documento</button>
        <button onclick="descargarQR('${id}')">üì∑ Descargar QR</button>
        <button onclick="eliminarCarpeta('${id}')">üóëÔ∏è Eliminar carpeta</button>
        <ul id="hist_${id}"></ul>
        <textarea id="ficha_${id}" class="editable-area" onchange="guardarFicha('${id}')">${datos.fichaEditable}</textarea>`;
      new QRious({ element: document.getElementById(`qr_${id}`), value: url, size: 100 });
      document.getElementById("carpetas").appendChild(div);
      iniciarCronometro(id, datos.creado);
      actualizarHistorial(id);
    }

    function guardarAccion(id) {
      const txt = document.getElementById(`txt_${id}`).value.trim();
      if (!txt) return;
      const fecha = new Date().toLocaleString();
      carpetas[id].acciones.push(`${fecha}: ${txt}`);
      document.getElementById(`txt_${id}`).value = "";
      localStorage.setItem(id, JSON.stringify(carpetas[id]));
      actualizarHistorial(id);
    }

    function guardarFicha(id) {
      const area = document.getElementById(`ficha_${id}`);
      if (area) {
        carpetas[id].fichaEditable = area.value;
        localStorage.setItem(id, JSON.stringify(carpetas[id]));
      }
    }

    function actualizarHistorial(id) {
      const ul = document.getElementById(`hist_${id}`);
      ul.innerHTML = "";
      carpetas[id].acciones.forEach((accion, i) => {
        const li = document.createElement("li");
        li.textContent = accion;
        const btnBorrar = document.createElement("button");
        btnBorrar.textContent = "üóëÔ∏è";
        btnBorrar.onclick = () => {
          carpetas[id].acciones.splice(i, 1);
          localStorage.setItem(id, JSON.stringify(carpetas[id]));
          actualizarHistorial(id);
        };
        li.appendChild(btnBorrar);
        ul.appendChild(li);
      });
    }

    function iniciarCronometro(id, inicio) {
      if (cronometrosActivos[id]) clearInterval(cronometrosActivos[id]);
      const cronEl = document.getElementById(`cron_${id}`);
      if (!cronEl) return;
      cronometrosActivos[id] = setInterval(() => {
        const delta = Math.floor((Date.now() - inicio) / 1000);
        const hh = String(Math.floor(delta / 3600)).padStart(2, '0');
        const mm = String(Math.floor((delta % 3600) / 60)).padStart(2, '0');
        const ss = String(delta % 60).padStart(2, '0');
        cronEl.textContent = `${hh}:${mm}:${ss}`;
      }, 1000);
    }

    function descargarQR(id) {
      const datos = carpetas[id];
      if (!datos) return;

      const url = location.href.split("#")[0] + `#${encodeURIComponent(id)}`;

      // Crear un nuevo canvas temporal para forzar el dibujo correcto
      const canvasTemp = document.createElement("canvas");
      canvasTemp.width = 200;
      canvasTemp.height = 200;

      const qr = new QRious({
        element: canvasTemp,
        value: url,
        size: 200
      });

      const enlace = document.createElement("a");
      enlace.href = canvasTemp.toDataURL("image/png");
      enlace.download = `${datos.equipo}_QR.png`;
      enlace.click();
    }

    function eliminarCarpeta(id) {
      localStorage.removeItem(id);
      delete carpetas[id];
      const divs = document.querySelectorAll(".carpeta");
      divs.forEach(div => {
        if (div.innerHTML.includes(id)) div.remove();
      });
    }

    // Reloj en el header
    setInterval(() => {
      document.getElementById("reloj").textContent = "‚è± " + new Date().toLocaleTimeString();
    }, 1000);

    // Recuperar carpetas al cargar la p√°gina
    window.addEventListener("DOMContentLoaded", () => {
      for (let i = 0; i < localStorage.length; i++) {
        const clave = localStorage.key(i);
        if (clave.startsWith("carpeta_")) {
          const datos = JSON.parse(localStorage.getItem(clave));
          carpetas[clave] = datos;
          mostrarCarpeta(clave);
        }
      }
    });
  
  window.addEventListener("DOMContentLoaded", () => {
    let carpetaHash = decodeURIComponent(location.hash.slice(1));
    for (let i = 0; i < localStorage.length; i++) {
      const clave = localStorage.key(i);
      if (clave.startsWith("/Nuevedieciseis:carpeta_")) {
        const datos = JSON.parse(localStorage.getItem(clave));
        const cleanKey = clave.replace("/Nuevedieciseis:", "");
        carpetas[cleanKey] = datos;
        mostrarCarpeta(cleanKey);
      }
    }
    if (carpetaHash && carpetas[carpetaHash]) {
      document.getElementById(`qr_${carpetaHash}`)?.scrollIntoView({ behavior: "smooth" });
    }
  });
    
// üîÑ Al cargar la p√°gina, mostrar carpetas guardadas
window.addEventListener("DOMContentLoaded", () => {
  Object.keys(localStorage).forEach(id => {
    if (id.startsWith("carpeta_")) {
      try {
        carpetas[id] = JSON.parse(localStorage.getItem(id));
        mostrarCarpeta(id);
      } catch (e) {
        console.warn("Error cargando carpeta:", id);
      }
    }
  });
});

</script>
</body>
</html>
